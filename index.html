<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个性化AI导览助手 - 四川博物院</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 欢迎页面样式 */
        .welcome-page {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .logo {
            width: 200px;
            height: auto;
            margin-bottom: 30px;
        }

        .system-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .radio-item:hover, .checkbox-item:hover {
            background: #e9ecef;
        }

        .radio-item.selected, .checkbox-item.selected {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }

        .radio-item input, .checkbox-item input {
            display: none;
        }

        .submit-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        /* 导览页面样式 */
        .guide-page {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .control-panel {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .speak-btn {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .status-listening {
            background: #e8f5e8;
            color: #2d5016;
            border-left: 4px solid #4caf50;
        }

        .status-thinking {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #ff9800;
        }

        .status-speaking {
            background: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #2196f3;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status-idle {
            background: #f5f5f5;
            color: #666;
            border-left: 4px solid #999;
        }

        /* 加载页面样式 */
        .loading-page {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .loading-tips {
            font-size: 1em;
            color: #7f8c8d;
            line-height: 1.6;
        }

        /* 反馈页面样式 */
        .feedback-page {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .feedback-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .rating-group {
            margin-bottom: 30px;
            text-align: left;
        }

        .rating-label {
            font-size: 1.2em;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .star {
            font-size: 2em;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.active {
            color: #ffd700;
        }

        .star:hover {
            color: #ffb347;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .welcome-page, .guide-page, .loading-page, .feedback-page {
                padding: 20px;
            }

            .system-title {
                font-size: 2em;
            }

            .control-panel {
                flex-direction: column;
                align-items: center;
            }

            .radio-group, .checkbox-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 欢迎页面 -->
        <div id="welcomePage" class="welcome-page">
            <img src="https://www.scmuseum.cn/sccms/template/1/default/_files/img/home/logo.png" alt="四川博物院" class="logo">
            <h1 class="system-title">个性化AI导览助手</h1>
            <p class="subtitle">让AI为您量身定制专属的博物馆之旅</p>
            
            <form id="userProfileForm">
                <div class="form-group">
                    <label>性别</label>
                    <div class="radio-group">
                        <div class="radio-item" data-value="男">
                            <input type="radio" name="gender" value="男">
                            男
                        </div>
                        <div class="radio-item" data-value="女">
                            <input type="radio" name="gender" value="女">
                            女
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>年龄</label>
                    <select name="age" class="form-control" required>
                        <option value="">请选择年龄段</option>
                        <option value="10-18">10-18岁</option>
                        <option value="18-35">18-35岁</option>
                        <option value="35-50">35-50岁</option>
                        <option value="50+">50岁以上</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>文化程度</label>
                    <select name="education" class="form-control" required>
                        <option value="">请选择文化程度</option>
                        <option value="小学">小学</option>
                        <option value="初中">初中</option>
                        <option value="高中">高中</option>
                        <option value="大学">大学</option>
                        <option value="研究生">研究生及以上</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>参观展厅</label>
                    <select name="exhibition" class="form-control" required>
                        <option value="古代四川馆">古代四川馆</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>计划参观时长</label>
                    <div class="radio-group">
                        <div class="radio-item" data-value="10分钟">
                            <input type="radio" name="duration" value="10分钟">
                            10分钟
                        </div>
                        <div class="radio-item" data-value="30分钟">
                            <input type="radio" name="duration" value="30分钟">
                            30分钟
                        </div>
                        <div class="radio-item" data-value="60分钟">
                            <input type="radio" name="duration" value="60分钟">
                            60分钟
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>参观兴趣（可多选）</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" data-value="珍品">
                            <input type="checkbox" name="interests" value="珍品">
                            珍品
                        </div>
                        <div class="checkbox-item" data-value="热门">
                            <input type="checkbox" name="interests" value="热门">
                            热门
                        </div>
                        <div class="checkbox-item" data-value="瓷器">
                            <input type="checkbox" name="interests" value="瓷器">
                            瓷器
                        </div>
                        <div class="checkbox-item" data-value="陶器">
                            <input type="checkbox" name="interests" value="陶器">
                            陶器
                        </div>
                        <div class="checkbox-item" data-value="青铜器">
                            <input type="checkbox" name="interests" value="青铜器">
                            青铜器
                        </div>
                    </div>
                    <input type="text" name="customInterest" class="form-control" style="margin-top: 15px;" placeholder="其他兴趣（可选）">
                </div>

                <div class="form-group">
                    <label>语言</label>
                    <div class="radio-group">
                        <div class="radio-item selected" data-value="中文">
                            <input type="radio" name="language" value="中文" checked>
                            中文
                        </div>
                        <div class="radio-item" data-value="English">
                            <input type="radio" name="language" value="English">
                            English
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn">开始我的专属导览</button>
            </form>
        </div>

        <!-- 加载页面 -->
        <div id="loadingPage" class="loading-page">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在生成您的专属导览路线...</div>
            <div class="loading-tips">
                AI正在根据您的兴趣和偏好，<br>
                精心规划最适合您的参观路线和讲解内容
            </div>
        </div>

        <!-- 导览页面 -->
        <div id="guidePage" class="guide-page">
            <h2 style="color: #2c3e50; margin-bottom: 30px;">AI导览助手</h2>
            
            <div class="control-panel">
                <button id="speakBtn" class="control-btn speak-btn">开始说话</button>
                <button id="stopBtn" class="control-btn stop-btn">停止</button>
            </div>

            <div id="statusIndicator" class="status-indicator status-idle">
                准备就绪，点击"开始说话"与AI导览员交流
            </div>
        </div>

        <!-- 反馈页面 -->
        <div id="feedbackPage" class="feedback-page">
            <h2 class="feedback-title">感谢您的参观，请为我们的服务评分</h2>
            
            <form id="feedbackForm">
                <div class="rating-group">
                    <div class="rating-label">路线设计</div>
                    <div class="rating-stars" data-rating="route">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">讲解内容</div>
                    <div class="rating-stars" data-rating="content">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">服务质量</div>
                    <div class="rating-stars" data-rating="service">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">交互效果</div>
                    <div class="rating-stars" data-rating="interaction">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>

                <button type="submit" class="submit-btn">提交反馈</button>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentState = 'idle';
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUtterance;
        let isListening = false;
        let userProfile = {};
        let tourRoute = [];
        let currentStepIndex = 0;
        let ratings = {};
        
        // API配置
        const API_BASE_URL = 'https://museum-ai.zeabur.app'; // 本地测试URL

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupFormHandlers();
            setupSpeechRecognition();
            setupControlButtons();
            setupRatingSystem();
            
            // 检查API连接
            checkAPIConnection();
        }
        
        // 检查API连接状态
        async function checkAPIConnection() {
            try {
                const response = await fetch(API_BASE_URL);
                console.log('API连接正常');
            } catch (error) {
                console.warn('API连接失败，将使用本地模拟模式:', error);
            }
        }

        // 设置表单处理器
        function setupFormHandlers() {
            // 单选按钮处理
            document.querySelectorAll('.radio-item').forEach(item => {
                item.addEventListener('click', function() {
                    const group = this.parentNode;
                    group.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                });
            });

            // 多选按钮处理
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                });
            });

            // 表单提交处理
            document.getElementById('userProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitUserProfile();
            });

            // 反馈表单提交处理
            document.getElementById('feedbackForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitFeedback();
            });
        }

        // 提交用户画像
        async function submitUserProfile() {
            const formData = new FormData(document.getElementById('userProfileForm'));
            
            // 收集兴趣数据
            const interests = [];
            document.querySelectorAll('input[name="interests"]:checked').forEach(input => {
                interests.push(input.value);
            });
            
            if (formData.get('customInterest').trim()) {
                interests.push(formData.get('customInterest').trim());
            }

            userProfile = {
                gender: formData.get('gender'),
                age: formData.get('age'),
                education: formData.get('education'),
                exhibition: formData.get('exhibition'),
                duration: formData.get('duration'),
                interests: interests,
                language: formData.get('language')
            };

            // 显示加载页面
            showPage('loadingPage');

            try {
                // 生成导览路线
                await generateTourRoute();
                
                // 显示导览页面
                showPage('guidePage');
                
                // 开始导览
                startTour();
                
            } catch (error) {
                console.error('生成导览路线失败:', error);
                updateStatus('生成导览路线失败，请重试', 'error');
                showPage('welcomePage');
            }
        }

        // API调用函数
        async function callAPI(endpoint, data = null) {
            const url = `${API_BASE_URL}/api${endpoint}`;
            const options = {
                method: data ? 'POST' : 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);
            return response.json();
        }

        // 生成导览路线
        async function generateTourRoute() {
            try {
                const response = await callAPI('/generate_route', userProfile);
                if (response.success) {
                    tourRoute = response.route;
                    currentStepIndex = 0;
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('生成导览路线失败:', error);
                throw error;
            }
        }

        // 调用AI API处理用户问题
        async function callAIAPI(userInput) {
            try {
                const response = await callAPI('/chat', {
                    message: userInput,
                    user_profile: userProfile,
                    context: {
                        current_item: tourRoute[currentStepIndex]?.id,
                        step_index: currentStepIndex
                    }
                });

                if (response.success) {
                    return response.response;
                } else {
                    throw new Error(response.response);
                }
            } catch (error) {
                console.error('AI处理失败:', error);
                throw error;
            }
        }


        // 开始导览
        function startTour() {
            const welcomeText = `您好，欢迎来到${userProfile.exhibition}，很高兴为您服务，让我们开始今天的参观吧！`;
            speak(welcomeText, () => {
                introduceNextStep();
            });
        }

        // 介绍下一个参观点
        function introduceNextStep() {
            if (currentStepIndex >= tourRoute.length) {
                endTour();
                return;
            }

            const currentItem = tourRoute[currentStepIndex];
            const introText = `现在我们要参观的是${currentItem.name}，请您前往${currentItem.location}，到了以后请说"请继续"。`;
            
            speak(introText);
        }

        // 讲解当前藏品
        function explainCurrentItem() {
            if (currentStepIndex >= tourRoute.length) {
                endTour();
                return;
            }

            const currentItem = tourRoute[currentStepIndex];
            speak(currentItem.description, () => {
                currentStepIndex++;
                if (currentStepIndex < tourRoute.length) {
                    const nextItem = tourRoute[currentStepIndex];
                    const transitionText = `接下来我们将参观${nextItem.name}，请跟我来，前往${nextItem.location}。`;
                    speak(transitionText, () => {
                        // 给用户一些时间移动
                        setTimeout(() => {
                            introduceNextStep();
                        }, 5000);
                    });
                } else {
                    endTour();
                }
            });
        }

        // 结束导览
        function endTour() {
            const farewellText = "今天的导览就到这里了，感谢您的参观！希望您度过了愉快的时光，期待您下次再来。";
            speak(farewellText, () => {
                showPage('feedbackPage');
            });
        }

        // 设置语音识别
        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            }

            if (recognition) {
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = userProfile.language === 'English' ? 'en-US' : 'zh-CN';

                recognition.onstart = function() {
                    isListening = true;
                    updateStatus('正在聆听您的话语...', 'listening');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('识别到:', transcript);
                    processUserInput(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('语音识别错误:', event.error);
                    updateStatus('语音识别失败，请重试', 'error');
                    isListening = false;
                };

                recognition.onend = function() {
                    isListening = false;
                    if (currentState !== 'speaking') {
                        updateStatus('准备就绪，点击"开始说话"与AI导览员交流', 'idle');
                    }
                };
            }
        }

        // 处理用户输入
        async function processUserInput(input) {
            updateStatus('正在思考...', 'thinking');
            
            // 检查是否是特定指令
            if (input.includes('请继续') || input.includes('继续')) {
                explainCurrentItem();
                return;
            }

            try {
                const response = await callAIAPI(input);
                speak(response);
            } catch (error) {
                console.error('AI处理失败:', error);
                const errorResponse = "抱歉，我没有听清楚您的问题，请您再说一遍。";
                speak(errorResponse);
            }
        }

        // 设置控制按钮
        function setupControlButtons() {
            document.getElementById('speakBtn').addEventListener('click', startListening);
            document.getElementById('stopBtn').addEventListener('click', stopSpeaking);
        }

        // 开始聆听
        function startListening() {
            if (recognition && !isListening) {
                recognition.start();
            } else {
                updateStatus('您的浏览器不支持语音识别功能', 'error');
            }
        }

        // 停止说话
        function stopSpeaking() {
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            if (currentUtterance) {
                currentUtterance = null;
            }
            updateStatus('已停止语音播放', 'idle');
        }

        // 语音播放 - 使用OpenAI TTS
        async function speak(text, callback) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }

            try {
                // 尝试使用OpenAI TTS
                const response = await callAPI('/generate_speech', {
                    text: text,
                    user_profile: userProfile
                });

                if (response.success && response.audio_data) {
                    // 播放OpenAI生成的高质量语音
                    playAudioFromBase64(response.audio_data, callback);
                } else {
                    // 降级到浏览器TTS
                    fallbackToWebTTS(text, callback);
                }
            } catch (error) {
                console.error('OpenAI TTS失败，使用浏览器TTS:', error);
                fallbackToWebTTS(text, callback);
            }
        }

        // 播放base64编码的音频
        function playAudioFromBase64(audioBase64, callback) {
            const audio = new Audio('data:audio/mpeg;base64,' + audioBase64);
            
            audio.onloadstart = function() {
                currentState = 'speaking';
                updateStatus('AI正在为您讲解...', 'speaking');
            };

            audio.onended = function() {
                currentState = 'idle';
                updateStatus('准备就绪，点击"开始说话"与AI导览员交流', 'idle');
                if (callback) callback();
            };

            audio.onerror = function(event) {
                console.error('音频播放错误:', event.error);
                updateStatus('音频播放失败，尝试备用方案', 'error');
                fallbackToWebTTS(text, callback);
            };

            audio.play().catch(error => {
                console.error('音频播放失败:', error);
                fallbackToWebTTS(text, callback);
            });
        }

        // 降级到浏览器原生TTS
        function fallbackToWebTTS(text, callback) {
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = userProfile.language === 'English' ? 'en-US' : 'zh-CN';
            currentUtterance.rate = 0.8;
            currentUtterance.pitch = 1;

            // 尝试选择更好的声音
            const voices = synthesis.getVoices();
            let selectedVoice = null;

            if (userProfile.language === 'English') {
                // 英文声音优先级
                const preferredVoices = ['Microsoft Zira Desktop', 'Google US English', 'Alex'];
                for (const voiceName of preferredVoices) {
                    selectedVoice = voices.find(voice => voice.name.includes(voiceName));
                    if (selectedVoice) break;
                }
            } else {
                // 中文声音优先级
                const preferredVoices = ['Microsoft Yaoyao Desktop', 'Google 普通话（中国大陆）', 'Ting-Ting'];
                for (const voiceName of preferredVoices) {
                    selectedVoice = voices.find(voice => voice.name.includes(voiceName));
                    if (selectedVoice) break;
                }
            }

            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
            }

            currentUtterance.onstart = function() {
                currentState = 'speaking';
                updateStatus('AI正在为您讲解...', 'speaking');
            };

            currentUtterance.onend = function() {
                currentState = 'idle';
                updateStatus('准备就绪，点击"开始说话"与AI导览员交流', 'idle');
                if (callback) callback();
            };

            currentUtterance.onerror = function(event) {
                console.error('语音播放错误:', event.error);
                updateStatus('语音播放失败', 'error');
                currentState = 'idle';
            };

            synthesis.speak(currentUtterance);
        }

        // 更新状态指示器
        function updateStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator status-${type}`;
        }

        // 显示指定页面
        function showPage(pageId) {
            const pages = ['welcomePage', 'loadingPage', 'guidePage', 'feedbackPage'];
            pages.forEach(id => {
                document.getElementById(id).style.display = id === pageId ? 'block' : 'none';
            });
        }

        // 设置评分系统
        function setupRatingSystem() {
            document.querySelectorAll('.rating-stars').forEach(starsGroup => {
                const ratingType = starsGroup.getAttribute('data-rating');
                const stars = starsGroup.querySelectorAll('.star');
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        ratings[ratingType] = value;
                        
                        // 更新星星显示
                        stars.forEach((s, i) => {
                            const starValue = parseInt(s.getAttribute('data-value'));
                            if (starValue <= value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseenter', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        stars.forEach((s, i) => {
                            const starValue = parseInt(s.getAttribute('data-value'));
                            if (starValue <= value) {
                                s.style.color = '#ffb347';
                            } else {
                                s.style.color = '#ddd';
                            }
                        });
                    });
                });
                
                starsGroup.addEventListener('mouseleave', function() {
                    const currentRating = ratings[ratingType] || 0;
                    stars.forEach(s => {
                        const starValue = parseInt(s.getAttribute('data-value'));
                        if (starValue <= currentRating) {
                            s.style.color = '#ffd700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
        }

        // 提交反馈
        async function submitFeedback() {
            try {
                const response = await callAPI('/feedback', {
                    user_profile: userProfile,
                    ratings: ratings
                });

                if (response.success) {
                    alert('感谢您的反馈！您的意见对我们很重要。');
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('提交反馈失败:', error);
                alert('提交反馈失败，请重试');
            }
        }

        // 重置应用状态
        function resetApp() {
            userProfile = {};
            tourRoute = [];
            currentStepIndex = 0;
            ratings = {};
            currentState = 'idle';
            
            // 重置表单
            document.getElementById('userProfileForm').reset();
            document.querySelectorAll('.radio-item, .checkbox-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector('.radio-item[data-value="中文"]').classList.add('selected');
            
            // 重置评分
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('active');
                star.style.color = '#ddd';
            });
        }
    </script>
</body>
</html>
